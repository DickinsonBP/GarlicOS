/*------------------------------------------------------------------------------

	"CRON.c" : programa de prueba para el sistema operativo GARLIC 2.0;
	
	Muestra un cronómetro por la ventana del proceso, con minutos y segundos,
	utilizando matrices de 8x8 caracteres para visualizar los dígitos y el
	carácter ':', mediante la funcion GARLIC_printmat().
	El argumento del programa indicará el tiempo a esperar entre incrementos
	de segundo, además de determinar el color de los dígitos;
		0:	desbancar el proceso (blanco)
		1:	un segundo, es decir, tiempo real (amarillo)
		2:	dos segundos (verde)
		3:	tres segundos (rojo)

------------------------------------------------------------------------------*/

#include <GARLIC_API.h>			/* definición de las funciones API de GARLIC */

const char digitos[][8][8] =
	{	// dígito 0
	 {{	0x20, 0x20, 0x7F, 0x7F, 0x7F, 0x20, 0x20, 0},
	  {	0x20, 0x7F, 0x20, 0x20, 0x20, 0x7F, 0x20, 0},
	  {	0x20, 0x7F, 0x20, 0x20, 0x7F, 0x7F, 0x20, 0},
	  {	0x20, 0x7F, 0x20, 0x7F, 0x20, 0x7F, 0x20, 0},
	  {	0x20, 0x7F, 0x7F, 0x20, 0x20, 0x7F, 0x20, 0},
	  {	0x20, 0x7F, 0x20, 0x20, 0x20, 0x7F, 0x20, 0},
	  {	0x20, 0x20, 0x7F, 0x7F, 0x7F, 0x20, 0x20, 0},
	  { 0, 0, 0, 0, 0, 0, 0, 0}},
		// dígito 1
	 {{	0x20, 0x20, 0x20, 0x20, 0x7F, 0x20, 0x20, 0},
	  {	0x20, 0x20, 0x20, 0x7F, 0x7F, 0x20, 0x20, 0},
	  {	0x20, 0x20, 0x7F, 0x20, 0x7F, 0x20, 0x20, 0},
	  {	0x20, 0x20, 0x20, 0x20, 0x7F, 0x20, 0x20, 0},
	  {	0x20, 0x20, 0x20, 0x20, 0x7F, 0x20, 0x20, 0},
	  {	0x20, 0x20, 0x20, 0x20, 0x7F, 0x20, 0x20, 0},
	  {	0x20, 0x20, 0x20, 0x20, 0x7F, 0x20, 0x20, 0},
	  { 0, 0, 0, 0, 0, 0, 0, 0}},
		// dígito 2
	 {{	0x20, 0x20, 0x7F, 0x7F, 0x7F, 0x20, 0x20, 0},
	  {	0x20, 0x7F, 0x20, 0x20, 0x20, 0x7F, 0x20, 0},
	  {	0x20, 0x20, 0x20, 0x20, 0x20, 0x7F, 0x20, 0},
	  {	0x20, 0x20, 0x20, 0x20, 0x7F, 0x20, 0x20, 0},
	  {	0x20, 0x20, 0x20, 0x7F, 0x20, 0x20, 0x20, 0},
	  {	0x20, 0x20, 0x7F, 0x20, 0x20, 0x20, 0x20, 0},
	  {	0x20, 0x7F, 0x7F, 0x7F, 0x7F, 0x7F, 0x20, 0},
	  { 0, 0, 0, 0, 0, 0, 0, 0}},
		// dígito 3
	 {{	0x20, 0x20, 0x7F, 0x7F, 0x7F, 0x20, 0x20, 0},
	  {	0x20, 0x7F, 0x20, 0x20, 0x20, 0x7F, 0x20, 0},
	  {	0x20, 0x20, 0x20, 0x20, 0x20, 0x7F, 0x20, 0},
	  {	0x20, 0x20, 0x7F, 0x7F, 0x7F, 0x20, 0x20, 0},
	  {	0x20, 0x20, 0x20, 0x20, 0x20, 0x7F, 0x20, 0},
	  {	0x20, 0x7F, 0x20, 0x20, 0x20, 0x7F, 0x20, 0},
	  {	0x20, 0x20, 0x7F, 0x7F, 0x7F, 0x20, 0x20, 0},
	  { 0, 0, 0, 0, 0, 0, 0, 0}},
		// dígito 4
	 {{	0x20, 0x20, 0x20, 0x20, 0x7F, 0x20, 0x20, 0},
	  {	0x20, 0x20, 0x20, 0x7F, 0x7F, 0x20, 0x20, 0},
	  {	0x20, 0x20, 0x7F, 0x20, 0x7F, 0x20, 0x20, 0},
	  {	0x20, 0x7F, 0x20, 0x20, 0x7F, 0x20, 0x20, 0},
	  {	0x20, 0x7F, 0x7F, 0x7F, 0x7F, 0x7F, 0x20, 0},
	  {	0x20, 0x20, 0x20, 0x20, 0x7F, 0x20, 0x20, 0},
	  {	0x20, 0x20, 0x20, 0x20, 0x7F, 0x20, 0x20, 0},
	  { 0, 0, 0, 0, 0, 0, 0, 0}},
		// dígito 5
	 {{	0x20, 0x7F, 0x7F, 0x7F, 0x7F, 0x7F, 0x20, 0},
	  {	0x20, 0x7F, 0x20, 0x20, 0x20, 0x20, 0x20, 0},
	  {	0x20, 0x7F, 0x20, 0x7F, 0x7F, 0x20, 0x20, 0},
	  {	0x20, 0x7F, 0x7F, 0x20, 0x20, 0x7F, 0x20, 0},
	  {	0x20, 0x20, 0x20, 0x20, 0x20, 0x7F, 0x20, 0},
	  {	0x20, 0x7F, 0x20, 0x20, 0x20, 0x7F, 0x20, 0},
	  {	0x20, 0x20, 0x7F, 0x7F, 0x7F, 0x20, 0x20, 0},
	  { 0, 0, 0, 0, 0, 0, 0, 0}},
		// dígito 6
	 {{	0x20, 0x20, 0x20, 0x7F, 0x7F, 0x20, 0x20, 0},
	  {	0x20, 0x20, 0x7F, 0x20, 0x20, 0x20, 0x20, 0},
	  {	0x20, 0x7F, 0x20, 0x20, 0x20, 0x20, 0x20, 0},
	  {	0x20, 0x7F, 0x7F, 0x7F, 0x7F, 0x20, 0x20, 0},
	  {	0x20, 0x7F, 0x20, 0x20, 0x20, 0x7F, 0x20, 0},
	  {	0x20, 0x7F, 0x20, 0x20, 0x20, 0x7F, 0x20, 0},
	  {	0x20, 0x20, 0x7F, 0x7F, 0x7F, 0x20, 0x20, 0},
	  { 0, 0, 0, 0, 0, 0, 0, 0}},
		// dígito 7
	 {{	0x20, 0x7F, 0x7F, 0x7F, 0x7F, 0x7F, 0x20, 0},
	  {	0x20, 0x20, 0x20, 0x20, 0x20, 0x7F, 0x20, 0},
	  {	0x20, 0x20, 0x20, 0x20, 0x7F, 0x20, 0x20, 0},
	  {	0x20, 0x20, 0x20, 0x20, 0x7F, 0x20, 0x20, 0},
	  {	0x20, 0x20, 0x20, 0x7F, 0x20, 0x20, 0x20, 0},
	  {	0x20, 0x20, 0x20, 0x7F, 0x20, 0x20, 0x20, 0},
	  {	0x20, 0x20, 0x20, 0x7F, 0x20, 0x20, 0x20, 0},
	  { 0, 0, 0, 0, 0, 0, 0, 0}},
		// dígito 8
	 {{	0x20, 0x20, 0x7F, 0x7F, 0x7F, 0x20, 0x20, 0},
	  {	0x20, 0x7F, 0x20, 0x20, 0x20, 0x7F, 0x20, 0},
	  {	0x20, 0x7F, 0x20, 0x20, 0x20, 0x7F, 0x20, 0},
	  {	0x20, 0x20, 0x7F, 0x7F, 0x7F, 0x20, 0x20, 0},
	  {	0x20, 0x7F, 0x20, 0x20, 0x20, 0x7F, 0x20, 0},
	  {	0x20, 0x7F, 0x20, 0x20, 0x20, 0x7F, 0x20, 0},
	  {	0x20, 0x20, 0x7F, 0x7F, 0x7F, 0x20, 0x20, 0},
	  { 0, 0, 0, 0, 0, 0, 0, 0}},
		// dígito 9
	 {{	0x20, 0x20, 0x7F, 0x7F, 0x7F, 0x20, 0x20, 0},
	  {	0x20, 0x7F, 0x20, 0x20, 0x20, 0x7F, 0x20, 0},
	  {	0x20, 0x7F, 0x20, 0x20, 0x20, 0x7F, 0x20, 0},
	  {	0x20, 0x20, 0x7F, 0x7F, 0x7F, 0x7F, 0x20, 0},
	  {	0x20, 0x20, 0x20, 0x20, 0x20, 0x7F, 0x20, 0},
	  {	0x20, 0x20, 0x20, 0x20, 0x7F, 0x20, 0x20, 0},
	  {	0x20, 0x20, 0x7F, 0x7F, 0x20, 0x20, 0x20, 0},
	  { 0, 0, 0, 0, 0, 0, 0, 0}},
		// carácter ':'
	 {{	0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0},
	  {	0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0},
	  {	0x20, 0x20, 0x7F, 0x20, 0x20, 0x20, 0x20, 0},
	  {	0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0},
	  {	0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0},
	  {	0x20, 0x20, 0x7F, 0x20, 0x20, 0x20, 0x20, 0},
	  {	0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0},
	  { 0, 0, 0, 0, 0, 0, 0, 0}}};


int _start(int arg)				/* función de inicio : no se usa 'main' */
{
	int umin, dmin, useg, dseg;
	unsigned char masc;
	
	if (arg < 0) arg = 0;			// limitar valor mínimo del argumento 
	if (arg > 3) arg = 3;			// limitar valor máximo del argumento

	GARLIC_clear();
									// esccribir mensaje inicial
	GARLIC_printf("-- Programa CRON  -  PID %2(%d) %0--\n", GARLIC_pid());

	dmin = 0; umin = 0;
	dseg = 0; useg = 0;	
									// imprimir "00:00"
	GARLIC_printmat(0, 8, (char (*)[8]) digitos[0], arg);
	GARLIC_printmat(7, 8, (char (*)[8]) digitos[0], arg);
	GARLIC_printmat(14, 8, (char (*)[8]) digitos[10], arg);
	GARLIC_printmat(19, 8, (char (*)[8]) digitos[0], arg);
	GARLIC_printmat(26, 8, (char (*)[8]) digitos[0], arg);
	do
	{
		GARLIC_delay(arg);			// retardo dependiendo del argumento
		useg++;						// incrementar unidades de segundo
		masc = 0;					// resetear máscara de modificaciones
		if (useg == 10)
		{	useg = 0;				// desbordamiento de unidades de segundo
			dseg++;
			masc |= 0x01;	
			if (dseg == 6)
			{	dseg = 0;			// desbordamiento de decenas de segundo
				umin++;
				masc |= 0x02;
				if (umin == 10)
				{	umin = 0;		// desbordamiento de unidades de minuto
					dmin++;
					masc |= 0x04;
				}
			}
		}
		GARLIC_printmat(26, 8, (char (*)[8]) digitos[useg], arg);
		if (masc & 0x01)
			GARLIC_printmat(19, 8, (char (*)[8]) digitos[dseg], arg);
		if (masc & 0x02)
			GARLIC_printmat(7, 8, (char (*)[8]) digitos[umin], arg);
		if (masc & 0x04)
			GARLIC_printmat(0, 8, (char (*)[8]) digitos[dmin], arg);	
	} while (dmin < 9); 			// acaba a los 90 minutos
	return 0;
}
